SELECT DISTINCT
  ef.EVENTNAME AS Outage,
  ef.SERVICECENTER AS SvC_Cntr,
  ef.STARTDATETIME AS Power_off_Date,
  ef.MAXRESTOREDDATETIME AS Restoration_Date,
  ef.EVENTLOCATION AS Event_Location,
  SS.OUTAGE_CAUSE_CODE AS Cause_Code_1,
  cd.CAUSECODE AS Cause_Code,
  SS.OUTAGE_CAUSE_DESC AS Outage_Cause_Desc,
  ARRAY_TO_STRING(ARRAY_AGG(action_taken) OVER (PARTITION BY ss.EVENTNAME), ' . ') AS Action_Taken,
  SS.CREW_NAME AS Completed_by,
  SS.CREW_NOTES AS Remarks
FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef 
LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` SS ON SS.EVENTNAME = ef.EVENTNAME
LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` cd ON ef.causekey = cd.causekey
CROSS JOIN UNNEST([ss.ACTION_TAKEN_1, ss.ACTION_TAKEN_2, ss.ACTION_TAKEN_3, 
                   ss.ACTION_TAKEN_4, ss.ACTION_TAKEN_5, ss.ACTION_TAKEN_6]) AS action_taken
WHERE 
  ef.MAXRESTOREDDATETIME >= DATETIME('2024-01-01T00:00:00') 
  AND ef.MAXRESTOREDDATETIME <= DATETIME('2024-12-31T23:59:59')
  AND ef.MOMENTARYOUTAGEFLAG = 0 
  AND ef.ORPHANOUTAGEFLAG = 0 
  AND ef.CANCELLEDFLAG = 0
  AND action_taken = '314 - Rpld BU Trans' 
  AND ef.servicecenter NOT IN ('BV','EV','FB','MV','RP') 
  AND ef.causekey NOT IN (43,85,48,55,17,35,71,78,27,15)
ORDER BY ef.MAXRESTOREDDATETIME, ef.SERVICECENTER


--SELECT DISTINCT CAUSEID, CAUSECODE FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` 
--WHERE CAUSECODE LIKE '%Pole%'
--SELECT DISTINCT EVENTNAME, ACTION_TAKEN_1,ACTION_TAKEN_2,ACTION_TAKEN_3,ACTION_TAKEN_4,ACTION_TAKEN_5, ACTION_TAKEN_6 FROM --`cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` WHERE (ACTION_TAKEN_1 = '314 - Rpld BU Trans' OR ACTION_TAKEN_2 = --'314 - Rpld BU Trans' OR ACTION_TAKEN_3 ='314 - Rpld BU Trans' OR ACTION_TAKEN_4 = '314 - Rpld BU Trans'OR ACTION_TAKEN_5 = '314 - Rpld --BU Trans' OR ACTION_TAKEN_6 = '314 - Rpld BU Trans')

