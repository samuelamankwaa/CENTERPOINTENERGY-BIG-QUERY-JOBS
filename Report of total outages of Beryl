WITH filtered_events AS (
  SELECT
    ef.EVENTNAME,
    ef.STARTDATETIME,
    ef.COMPLETEDDATETIME,
    ef.SERVICECENTER,
    ef.MOMENTARYOUTAGEFLAG,
    ef.PLANNEDOTGFLAG,
    ef.DEVICENAME,
    ef.DURATIONHM,
    ss.OUTAGE_CAUSE_CODE,
    ss.OUTAGE_CAUSE_DESC,
    cf.CALLDESC,
    cf.NO_CALLS AS NUM_OF_CALLS,
    COALESCE(
      CONCAT(
        COALESCE(ss.ACTION_TAKEN_1, ''), 
        CASE WHEN ss.ACTION_TAKEN_2 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_2 ELSE '' END,
        CASE WHEN ss.ACTION_TAKEN_3 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_3 ELSE '' END,
        CASE WHEN ss.ACTION_TAKEN_4 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_4 ELSE '' END,
        CASE WHEN ss.ACTION_TAKEN_5 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_5 ELSE '' END,
        CASE WHEN ss.ACTION_TAKEN_6 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_6 ELSE '' END
      ), '') AS Action_Taken,
    ss.TRUCK_NUMBER,
    ss.CREW_NOTES AS COMMENTS
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CALL_FACT` cf 
    ON cf.EVENTKEY = ef.EVENTKEY
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss
    ON ef.EVENTNAME = ss.EVENTNAME
  WHERE ef.STARTDATETIME >= DATETIME('2024-07-07T00:00:00') 
    AND ef.STARTDATETIME < DATETIME('2024-07-09T23:59:59')
    AND ef.EXCLUDETROUBLEFLAG = 0
--    AND ef.MOMENTARYOUTAGEFLAG = 1
    AND ef.CANCELLEDFLAG = 0
  --  AND ef.TROUBLE_LVL IS NOT NULL
  --  AND ef.PLANNEDOTGFLAG = 0
    AND ef.CANCELLEDFLAG = 0
    AND ef.NONOUTGCALLFLAG = 0
    AND ef.ORPHANOUTAGEFLAG = 0
    AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP', 'INDIANA', 'EVANSVILLE')
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY ef.EVENTNAME 
    ORDER BY 
      COALESCE(
        ARRAY_LENGTH(SPLIT(
          CONCAT(
            COALESCE(ss.ACTION_TAKEN_1, ''), 
            CASE WHEN ss.ACTION_TAKEN_2 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_2 ELSE '' END,
            CASE WHEN ss.ACTION_TAKEN_3 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_3 ELSE '' END,
            CASE WHEN ss.ACTION_TAKEN_4 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_4 ELSE '' END,
            CASE WHEN ss.ACTION_TAKEN_5 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_5 ELSE '' END,
            CASE WHEN ss.ACTION_TAKEN_6 IS NOT NULL THEN ' . ' || ss.ACTION_TAKEN_6 ELSE '' END
          ), ' . '
        )), 0
      ) DESC,
      cf.NO_CALLS DESC
  ) = 1
)
SELECT
  EVENTNAME,
  STARTDATETIME,
  COMPLETEDDATETIME,
  SERVICECENTER,
  OUTAGE_CAUSE_CODE,
  OUTAGE_CAUSE_DESC, 
  MOMENTARYOUTAGEFLAG,
  PLANNEDOTGFLAG,
  NUM_OF_CALLS,
  ACTION_TAKEN,
  DEVICENAME,
  DURATIONHM,
  TRUCK_NUMBER,
  COMMENTS
FROM filtered_events;
