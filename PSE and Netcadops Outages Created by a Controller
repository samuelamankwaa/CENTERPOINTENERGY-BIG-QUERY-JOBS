FOR PSE OUTAGES
==========================================================================================================================================
WITH base AS (
  SELECT 
    al.EVENTNAME,
    al.OPERATOR_ID AS CONTROLLER_ID,
    REGEXP_EXTRACT(al.NEW_VALUE, r'Status:([^;]+)') AS STATUS,
    ef.STARTDATETIME,
    ef.RESTOREDDATETIME,
    ef.MOMENTARYOUTAGEFLAG,
    ef.PLANNEDOTGFLAG,
    ef.TROUBLE_LVL,
    ss.OUTAGE_CAUSE_CODE,
    ss.OUTAGE_CAUSE_DESC,
    tk.ACTION_TAKEN_CAT_NO,
    tk.ACTION_TAKEN_NAME,      
    ss.CREW_NOTES AS COMMENTS,
    ef.DURATIONHM,
    ROW_NUMBER() OVER (PARTITION BY ef.EVENTNAME ORDER BY ef.STARTDATETIME ASC) AS rn
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_GAP_AUDIT_LOG` al ON al.EVENTNAME = ef.EVENTNAME
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss ON ss.EVENTNAME = ef.EVENTNAME
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN` tk ON tk.EVENTNAME = ef.EVENTNAME
  WHERE ef.STARTDATETIME >= DATETIME("2025-01-01T00:00:00") 
    AND ef.STARTDATETIME < DATETIME("2025-10-09T23:00:00")
    AND (al.NEW_VALUE LIKE '%Created%' OR al.NEW_VALUE LIKE '%CREATED%') 
    AND ef.EXCLUDETROUBLEFLAG = 0
    AND ef.CANCELLEDFLAG = 0
    AND ef.NONOUTGCALLFLAG = 0
    AND ef.ORPHANOUTAGEFLAG = 0
    AND al.OPERATOR_ID NOT IN ('ABB ENGINE', 'SCADA','SUBSTATION','SUBSTATIONC','SYSTEM')
    AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP','INDIANA')
)
SELECT
  EVENTNAME,
  CONTROLLER_ID,
  STATUS,
  STARTDATETIME,
  RESTOREDDATETIME,
  MOMENTARYOUTAGEFLAG,
  PLANNEDOTGFLAG,
  TROUBLE_LVL,
  OUTAGE_CAUSE_CODE,
  OUTAGE_CAUSE_DESC,
  ACTION_TAKEN_CAT_NO,
  ACTION_TAKEN_NAME,
  COMMENTS,
  DURATIONHM
FROM base
WHERE rn = 1
ORDER BY STARTDATETIME;
