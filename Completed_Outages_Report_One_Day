SELECT DISTINCT
  ef.EVENTNAME AS Outage,
  ef.SERVICECENTER AS SvC_Cntr,
  ef.STARTDATETIME AS Power_off_Date,
  ef.MAXRESTOREDDATETIME AS Restoration_Date,
  ef.EVENTLOCATION AS Event_Location,
  SS.OUTAGE_CAUSE_CODE AS Cause_Code_1,
  cd.CAUSECODE AS Cause_Code,
  SS.OUTAGE_CAUSE_DESC AS Outage_Cause_Desc,
  ARRAY_TO_STRING(ARRAY_AGG(action_taken) OVER (PARTITION BY ss.EVENTNAME), ' . ') AS Action_Taken,
  SS.CREW_NAME AS Completed_by,
  ef.OPERATORCOMMENTS AS Remarks_1,
  SS.CREW_NOTES AS Remarks
FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef 
LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` SS ON SS.EVENTNAME = ef.EVENTNAME
LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` cd ON ef.causekey = cd.causekey
CROSS JOIN UNNEST([ss.ACTION_TAKEN_1, ss.ACTION_TAKEN_2, ss.ACTION_TAKEN_3, 
                   ss.ACTION_TAKEN_4, ss.ACTION_TAKEN_5, ss.ACTION_TAKEN_6]) AS action_taken
WHERE 
  ef.MAXRESTOREDDATETIME >= DATETIME('2025-04-21T00:00:00') 
  AND ef.MAXRESTOREDDATETIME <= DATETIME('2025-04-21T23:59:59')
  AND ef.MOMENTARYOUTAGEFLAG = 0 
  AND ef.ORPHANOUTAGEFLAG = 0 
  AND ef.CANCELLEDFLAG = 0 
  --AND (cd.CAUSECODE LIKE '%pmt%' OR  SS.OUTAGE_CAUSE_DESC LIKE '%pmt%' OR SS.CREW_NOTES LIKE '%pmt%' OR ef.OPERATORCOMMENTS LIKE '%pmt%' OR Action_Taken LIKE '%pmt%')    
  AND ef.servicecenter NOT IN ('BV','EV','FB','MV','RP') 
  AND ef.causekey NOT IN (43,85,48,55,17,35,71,78,27,15)
ORDER BY ef.MAXRESTOREDDATETIME, ef.SERVICECENTER


--SELECT DISTINCT CAUSEID, CAUSECODE FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` 
--WHERE CAUSECODE LIKE '%Pole%'

