SELECT DISTINCT
  ef.EVENTNAME AS Outage,
  ef.SERVICECENTER AS SvC_Cntr,
  ef.STARTDATETIME AS Power_off_Date,
  ef.MAXRESTOREDDATETIME AS Restoration_Date,
  ef.EVENTLOCATION AS Event_Location,
  SS.OUTAGE_CAUSE_CODE AS Cause_Code,
  SS.OUTAGE_CAUSE_DESC,
  ARRAY_TO_STRING(ARRAY_AGG(action_taken) OVER (PARTITION BY ss.EVENTNAME), ' . ') AS ACTION_TAKEN,
  SS.CREW_NAME AS Completed_by,
  ef.OPERATORCOMMENTS AS Remarks
FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef 
LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` SS 
  ON SS.EVENTNAME = ef.EVENTNAME
CROSS JOIN UNNEST([ss.ACTION_TAKEN_1, ss.ACTION_TAKEN_2, ss.ACTION_TAKEN_3, 
                   ss.ACTION_TAKEN_4, ss.ACTION_TAKEN_5, ss.ACTION_TAKEN_6]) AS action_taken
WHERE 
  ef.MAXRESTOREDDATETIME >= DATETIME('2025-04-21T06:00:00') 
  AND ef.MAXRESTOREDDATETIME <= DATETIME('2025-04-21T16:00:00')
  AND ef.MOMENTARYOUTAGEFLAG = 0 
  AND ef.ORPHANOUTAGEFLAG = 0 
  AND ef.CANCELLEDFLAG = 0 
  AND ef.servicecenter NOT IN ('BV','EV','FB','MV','RP') 
  AND ef.causekey NOT IN (43,85,48,55,17,35,71,78,27,15)
ORDER BY ef.MAXRESTOREDDATETIME, ef.SERVICECENTER

