WITH ranked_events AS (
  SELECT
    ef.EVENTNAME,
    ef.STARTDATETIME,
    ef.RESTOREDDATETIME,
    ef.COMPLETEDDATETIME AS COMPLETION_DATE,
    ef.EVENTLOCATION AS LOCATION,
    ef.PLANNEDOTGFLAG,
    ef.SERVICECENTER,
    ef.FEEDERNAME,
    cd.CAUSECODE,
    ef.NUMCUSTDEENERGIZED AS CUSTOMERS_AFFACTED,
    ef.DEV_ID AS DEVICE_ID,
    ss.CREW_NAME,
    ss.CREW_ID,
    A.Tasks.WorkOrderTask.TaskAssignment.UserId AS CREW_NAME,
     omsat.action_taken AS ACTION_TAKEN,
    ef.OPERATORCOMMENTS AS COMMENTS,
    ROW_NUMBER() OVER (
      PARTITION BY ef.EVENTNAME 
      ORDER BY ef.COMPLETEDDATETIME DESC
    ) AS row_num
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss  
    ON ef.EVENTNAME = ss.EVENTNAME
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` cd 
    ON ef.causekey = cd.causekey
  LEFT JOIN `cnp-datafoundation-prod.EAI_ELEC_OPS.T_ELEC_ORDER_TASKS` A
    ON ef.EVENTNAME = A.OrderNumber AND  TIMESTAMP_TRUNC(A.OrderUpdateTS, DAY) BETWEEN TIMESTAMP("2025-01-01") AND TIMESTAMP("2025-12-31")
  LEFT JOIN (
          SELECT distinct
             eventname,
               string_agg(action_taken_name,' , ' ORDER BY eventname) AS action_taken
          FROM
             `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN`
         Where
         1=1
  GROUP BY
              eventname
     ) omsat ON ef.eventname = omsat.eventname
  WHERE ef.STARTDATETIME BETWEEN "2025-01-01T00:00:00" AND "2025-12-31T23:59:59"
       AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP', 'INDIANA')
 --  AND cd.CAUSECODE IN ( 'IN - Inspection, Test, Repair or Change','CR - Customer Requested Work')-------PLANNED OUTAGES ONLY
--   AND cd.CAUSECODE IN ('EM - Emergency threatens System',  'RS - Restoration of Service' , 'DC - Dangerous Conditions','TM - Tampering or Bypassing', 'LA - Legal Authorities')---------UNPLANNED OUTAGES (CREW) ONLY
    ORDER BY ef.STARTDATETIME, ef.RESTOREDDATETIME
)
SELECT * EXCEPT(row_num)
FROM ranked_events
WHERE row_num = 1
;
