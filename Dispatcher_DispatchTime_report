SELECT 
  ss.EVENTNAME AS EVENT_NUMBER,
  ef.FEEDERNAME AS FEEDER_NAME,
  ss.SERVICE_CENTER_NAME AS SERVICE_CENTER,
  ss.OUTAGE_DATE AS START_DATE_TIME,
  A.Tasks.WorkOrderTask.TaskTracking.EventByUserId AS DISPATCHER,
  DATETIME(A.Tasks.WorkOrderTask.TaskTracking.DispatchedAt,"America/Chicago") AS DISPATCH_TIME,
  ss.CREW_COMPLETION_DATE AS COMPLETION_DATE_TIME,
  ss.OUTAGE_CAUSE_CODE AS CAUSE_CODE,
  ss.CREW_NOTES AS COMPLETION_REMARKS,
  ARRAY_TO_STRING(ARRAY_AGG(action_taken) OVER (PARTITION BY ss.EVENTNAME), ' . ') AS ACTION_TAKEN
FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss
INNER JOIN `cnp-datafoundation-prod.EAI_ELEC_OPS.T_ELEC_ORDER_TASKS` A ON A.OrderNumber = ss.EVENTNAME
INNER JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef ON ef.EVENTNAME = ss.EVENTNAME
CROSS JOIN UNNEST([ss.ACTION_TAKEN_1, ss.ACTION_TAKEN_2, ss.ACTION_TAKEN_3, ss.ACTION_TAKEN_4, ss.ACTION_TAKEN_5, ss.ACTION_TAKEN_6]) AS action_taken
WHERE ss.OUTAGE_DATE BETWEEN DATETIME('2025-03-02 00:00:00') AND DATETIME('2025-03-02 23:59:59')
 AND TIMESTAMP_TRUNC(A.OrderUpdateTS, DAY) BETWEEN TIMESTAMP("2025-03-02") AND TIMESTAMP("2025-03-02")
 AND ef.MOMENTARYOUTAGEFLAG = 0
 AND ef.CANCELLEDFLAG = 0
 AND ef.PLANNEDOTGFLAG = 0
 AND ef.NONOUTGCALLFLAG = 0
 AND ef.ORPHANOUTAGEFLAG = 0
 AND ef.FEEDERNAME = 'PE03'



ELECT DISTINCT
A.OrderNumber,
B.SERVICECENTER,
B.TROUBLELEVEL,
B.CAUSENAME,
B.ACTUALPERIODSTART AS OutageDT,
A.OrderData.WorkOrderRecord.HazardLevelCode,
A.Tasks.WorkOrderTask.TaskTracking.EventByUserId AS DispatchedBy,
A.Tasks.WorkOrderTask.TaskAssignment.UserId AS DispatchedTo,
DATETIME(A.Tasks.WorkOrderTask.TaskTracking.DispatchedAt,"America/Chicago") AS DispatchedAt
FROM `cnp-datafoundation-prod.EAI_ELEC_OPS.T_ELEC_ORDER_TASKS` A
LEFT JOIN `cnp-datafoundation-prod.ADMS_OEP.T_FPRP_OUTAGE_HIST` B ON A.OrderNumber = B.EVENTNAME
WHERE
TIMESTAMP_TRUNC(A.OrderUpdateTS, DAY) BETWEEN TIMESTAMP("2024-09-27") AND TIMESTAMP("2024-09-29")
AND
B.ACTUALPERIODSTART BETWEEN DATETIME("2024-09-27") AND DATETIME("2024-09-28")
AND
A.OrderStatus = 'UnAcknowledged'
AND
B.MOMENTARYOUTAGEFLAG = 0
AND
B.ISPLANNED = 0
AND
B.CANCELLEDFLAG = 0
AND
B.EVENTNAME NOT LIKE '%.%'
AND
B.CAUSENAME NOT LIKE 'PS%'
AND
B.STATE = 'TX'
ORDER BY A.OrderNumber, OutageDT, DispatchedAt



