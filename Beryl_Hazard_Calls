SELECT DISTINCT
       ss.EVENTNAME,
       ef.FEEDERNAME,
       ef.STARTDATETIME,
       ef.RESTOREDDATETIME,
       ef.TROUBLE_LVL,
       cf.CALLERTYPE,
       cf.NO_CALLS AS NUM_OF_CALLS,
       omsat.action_taken AS ACTION_TAKEN,      
       ef.SERVICECENTER,
       ef.DEVICENAME,     
       ef.DURATIONHM
 FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss
 INNER JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef ON ef.EVENTNAME = ss.EVENTNAME
 INNER JOIN  `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CALL_FACT` cf ON cf.EVENTKEY = ef.EVENTKEY
 LEFT JOIN (
          SELECT distinct
             eventname,
               string_agg(action_taken_name,' , ' ORDER BY eventname) AS action_taken
          FROM
             `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN`
         Where
         1=1
  GROUP BY
              eventname
     ) omsat ON ef.eventname = omsat.eventname
 WHERE ef.STARTDATETIME >= DATETIME("2024-07-07T10:00:00") 
   AND ef.STARTDATETIME < DATETIME("2024-07-08T23:59:59")
   AND ef.EXCLUDETROUBLEFLAG = 0
   AND ef.MOMENTARYOUTAGEFLAG = 0
   AND ef.CANCELLEDFLAG = 0
   AND ef.PLANNEDOTGFLAG = 0
   AND ef.NONOUTGCALLFLAG = 0
   AND ef.ORPHANOUTAGEFLAG = 0
   AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP','INDIANA')
--   AND omsat.action_taken = '246 - Bypass Installed'
   AND ef.TROUBLE_LVL = 'C'
   AND ef.FEEDERNAME != '-Missing Feeder-'
 GROUP BY ef.EVENTNAME, ss.EVENTNAME,ef.STARTDATETIME,ef.RESTOREDDATETIME,omsat.action_taken,ef.SUBSTATIONNAME,ef.DURATIONHM, ef.SERVICECENTER,ef.FEEDERNAME,ef.TROUBLE_LVL, ef.DEVICENAME,cf.NO_CALLS, cf.CALLERTYPE
 ORDER BY ef.STARTDATETIME, ef.RESTOREDDATETIME 


-

