WITH ranked_events AS (
  SELECT
    ef.EVENTNAME,
    ef.STARTDATETIME,
    ef.RESTOREDDATETIME,
    ef.COMPLETEDDATETIME AS COMPLETION_DATE,
    ef.EVENTLOCATION AS LOCATION,
    ss.REQUIRES_WO AS CAPITOL_EVENT,
    ef.NUMCALLS AS NUMBER_OF_CALLS,
    ef.SERVICECENTER,
    ef.BUILD_TYPE AS SERVICE_CODE,
    ss.REFERRED,
    ss.REFERRED_DATE,
    cd.CAUSECODE,
    ef.NUMCUSTDEENERGIZED AS CUSTOMERS_AFFACTED,
    ef.DEV_ID AS DEVICE_ID,
    ss.CREW_NAME,
    ss.CREW_ID,
     omsat.action_taken AS ACTION_TAKEN,
    ef.OPERATORCOMMENTS AS COMMENTS,
    ROW_NUMBER() OVER (
      PARTITION BY ef.EVENTNAME 
      ORDER BY ef.COMPLETEDDATETIME DESC
    ) AS row_num
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
  INNER JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss  
    ON ef.EVENTNAME = ss.EVENTNAME
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` cd 
    ON ef.causekey = cd.causekey
  LEFT JOIN (
          SELECT distinct
             eventname,
               string_agg(action_taken_name,' , ' ORDER BY eventname) AS action_taken
          FROM
             `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN`
         Where
         1=1
  GROUP BY
              eventname
     ) omsat ON ef.eventname = omsat.eventname
  WHERE ef.STARTDATETIME BETWEEN "2025-01-01T00:00:00" AND "2025-12-31T23:59:59"
--    AND (ss.REQUIRES_WO NOT IN ('Y') OR ss.REQUIRES_WO IS NULL)
--    AND ss.REFERRED = 'Y'
--    AND ef.EXCLUDETROUBLEFLAG = 0
    AND ef.MOMENTARYOUTAGEFLAG = 0
--    AND ef.CANCELLEDFLAG = 0
    AND ef.TROUBLE_LVL IS NOT NULL
--    AND ef.PLANNEDOTGFLAG = 0
--    AND ef.NONOUTGCALLFLAG = 
--    AND ef.ORPHANOUTAGEFLAG = 0
    AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP', 'INDIANA')
    ORDER BY ef.COMPLETEDDATETIME, ef.RESTOREDDATETIME, ef.STARTDATETIME
)
SELECT * EXCEPT(row_num)
FROM ranked_events
WHERE row_num = 1
;


--SELECT * FROM `cnp-datafoundation-prod.ADMS_OEP.T_FPRP_OUTAGE_HIST`
--WHERE ACTUALPERIODSTART BETWEEN "2024-09-01T00:00:00" AND "2025-08-31T23:59:59"
--SELECT * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` LIMIT 600---
--select * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` 
--where CAUSECODE IN ('EM', 'IN', 'CR', 'DC', 'LA', 'RS', 'TM', 'UU', 'VT') LIMIT 1000

-- AND ef.EXCLUDETROUBLEFLAG = 0
--   AND ef.MOMENTARYOUTAGEFLAG = 0
 --  AND ef.CANCELLEDFLAG = 0
--   AND ef.EVENTNAME = '5443429'
 --  AND ef.TROUBLE_LVL IS NOT NULL
 --  AND ef.PLANNEDOTGFLAG = 1
--   AND ef.NONOUTGCALLFLAG = 0
 --  AND ef.ORPHANOUTAGEFLAG = 0
================================================================================================================================================================================================
================================================================================================================================================================================================

WITH actions_oms AS (
  SELECT
    eventname,
    STRING_AGG(action_taken_name, ' , ' ORDER BY action_taken_name) AS oms_action_taken
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN`
  GROUP BY eventname
),
ss_rollup AS (
  SELECT
    EVENTNAME,
    OUTAGE_CAUSE_CODE,
    OUTAGE_CAUSE_DESC,
    REFERRED,
    REFERRED_DATE,
    REFERRED_REASON,
    REFERRED_REASON_NOTES,
    FOLLOW_UP_ID,
    FOLLOW_UP_DESC,
    REQUIRES_WO,         -- "Work Order Required" / capital work indicator
    WORK_TAG,            -- additional work/capital context
    -- Collapse ACTION_TAKEN_1..6 into a single string (skip null/blank)
    (
      SELECT STRING_AGG(x, ' , ')
      FROM UNNEST([
        ACTION_TAKEN_1, ACTION_TAKEN_2, ACTION_TAKEN_3,
        ACTION_TAKEN_4, ACTION_TAKEN_5, ACTION_TAKEN_6
      ]) AS x
      WHERE x IS NOT NULL AND x != ''
    ) AS ss_action_taken
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE`
)
 
SELECT
  -- Keys
  ef.EVENTNAME                                    AS event_id,
  ef.EVENTKEY                                     AS event_key,
 
  -- Core times
  ef.STARTDATETIME                                AS start_datetime,
  ef.RESTOREDDATETIME                             AS restored_datetime,
  ef.COMPLETEDDATETIME                            AS completed_datetime,
  ef.DURATIONHM                                   AS duration_hm,
 
  -- Geography & asset
  ef.SERVICECENTER                                AS service_center,
  ef.SUBSTATIONNAME                               AS substation_name,
  ef.FEEDERNAME                                   AS circuit_name,
  ef.DEVICENAME                                   AS device_name,
 
  -- Impact & flags
  ef.NUMCUSTDEENERGIZED                           AS customers_deenergized,
  ef.NUMCALLS                                     AS num_calls,
  ef.TROUBLE_LVL                                  AS trouble_level,
  ef.MOMENTARYOUTAGEFLAG                          AS momentary_flag,
  ef.CANCELLEDFLAG                                AS canceled_flag,
 
  -- Cause (OMS dim) + comments
  cd.CAUSECODE                                    AS oms_cause_code,
  cd.CAUSEDESC                                    AS oms_cause_desc,
  ef.OPERATORCOMMENTS                             AS operator_comments,
 
  -- Action taken (OMS view)
  ao.oms_action_taken                             AS oms_action_taken,
 
  -- Service Suite enrichment (referrals, follow-ups, WO/capital, SS actions)
  ss.OUTAGE_CAUSE_CODE                            AS ss_cause_code,
  ss.OUTAGE_CAUSE_DESC                            AS ss_cause_desc,
  ss.REFERRED                                     AS ss_referred_ind,
  ss.REFERRED_DATE                                AS ss_referred_date,
  ss.REFERRED_REASON                              AS ss_referred_reason,
  ss.REFERRED_REASON_NOTES                        AS ss_referred_reason_notes,
  ss.FOLLOW_UP_ID                                 AS ss_follow_up_id,
  ss.FOLLOW_UP_DESC                               AS ss_follow_up_desc,
  ss.REQUIRES_WO                                  AS ss_requires_wo,      -- capital/work order flag
  ss.WORK_TAG                                     AS ss_work_tag,
  ss.ss_action_taken                              AS ss_action_taken
 
FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` AS ef
LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` AS cd
  ON ef.CAUSEKEY = cd.CAUSEKEY
LEFT JOIN actions_oms AS ao
  ON ef.EVENTNAME = ao.EVENTNAME
LEFT JOIN ss_rollup AS ss
  ON ef.EVENTNAME = ss.EVENTNAME
 
WHERE
  -- 365-day lookback (use DATETIME to match ef.STARTDATETIME type)
  ef.STARTDATETIME BETWEEN "2025-01-01T00:00:00" AND "2025-12-31T23:59:59"
  -- Exclusions you requested
  AND ef.CANCELLEDFLAG = 0
  AND ef.MOMENTARYOUTAGEFLAG = 0
  AND UPPER(ef.SERVICECENTER) NOT IN ('BV','EV','FB','MV','RP','EVANSVILLE','INDIANA')
 
ORDER BY ef.STARTDATETIME ASC;
 
