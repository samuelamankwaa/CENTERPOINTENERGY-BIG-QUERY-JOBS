WITH ranked_events AS (
  SELECT
    ef.EVENTNAME,
    ef.STARTDATETIME,
    ef.RESTOREDDATETIME,
    ef.COMPLETEDDATETIME AS COMPLETION_DATE,
    ef.EVENTLOCATION AS LOCATION,
    ss.REQUIRES_WO AS CAPITOL_EVENT,
    ef.NUMCALLS AS NUMBER_OF_CALLS,
    ef.SERVICECENTER,
    ef.BUILD_TYPE AS SERVICE_CODE,
    ss.REFERRED,
    ss.REFERRED_DATE,
    cd.CAUSECODE,
    ef.NUMCUSTDEENERGIZED AS CUSTOMERS_AFFACTED,
    ef.DEV_ID AS DEVICE_ID,
    ss.CREW_NAME,
    ss.CREW_ID,
     omsat.action_taken AS ACTION_TAKEN,
    ef.OPERATORCOMMENTS AS COMMENTS,
    ROW_NUMBER() OVER (
      PARTITION BY ef.EVENTNAME 
      ORDER BY ef.COMPLETEDDATETIME DESC
    ) AS row_num
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
  INNER JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss  
    ON ef.EVENTNAME = ss.EVENTNAME
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` cd 
    ON ef.causekey = cd.causekey
  LEFT JOIN (
          SELECT distinct
             eventname,
               string_agg(action_taken_name,' , ' ORDER BY eventname) AS action_taken
          FROM
             `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN`
         Where
         1=1
  GROUP BY
              eventname
     ) omsat ON ef.eventname = omsat.eventname
  WHERE ef.STARTDATETIME BETWEEN "2025-01-01T00:00:00" AND "2025-12-31T23:59:59"
--    AND (ss.REQUIRES_WO NOT IN ('Y') OR ss.REQUIRES_WO IS NULL)
--    AND ss.REFERRED = 'Y'
--    AND ef.EXCLUDETROUBLEFLAG = 0
    AND ef.MOMENTARYOUTAGEFLAG = 0
--    AND ef.CANCELLEDFLAG = 0
    AND ef.TROUBLE_LVL IS NOT NULL
--    AND ef.PLANNEDOTGFLAG = 0
--    AND ef.NONOUTGCALLFLAG = 
--    AND ef.ORPHANOUTAGEFLAG = 0
    AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP', 'INDIANA')
    ORDER BY ef.COMPLETEDDATETIME, ef.RESTOREDDATETIME, ef.STARTDATETIME
)
SELECT * EXCEPT(row_num)
FROM ranked_events
WHERE row_num = 1
;


--SELECT * FROM `cnp-datafoundation-prod.ADMS_OEP.T_FPRP_OUTAGE_HIST`
--WHERE ACTUALPERIODSTART BETWEEN "2024-09-01T00:00:00" AND "2025-08-31T23:59:59"
--SELECT * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` LIMIT 600---
--select * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` 
--where CAUSECODE IN ('EM', 'IN', 'CR', 'DC', 'LA', 'RS', 'TM', 'UU', 'VT') LIMIT 1000

-- AND ef.EXCLUDETROUBLEFLAG = 0
--   AND ef.MOMENTARYOUTAGEFLAG = 0
 --  AND ef.CANCELLEDFLAG = 0
--   AND ef.EVENTNAME = '5443429'
 --  AND ef.TROUBLE_LVL IS NOT NULL
 --  AND ef.PLANNEDOTGFLAG = 1
--   AND ef.NONOUTGCALLFLAG = 0
 --  AND ef.ORPHANOUTAGEFLAG = 0
