WITH ranked_events AS (
  SELECT
    ef.EVENTNAME,
    ef.STARTDATETIME,
    ef.RESTOREDDATETIME,
    ef.TROUBLE_LVL,
    ef.SERVICECENTER,
    ef.NUMCUSTDEENERGIZED AS NUMBER_OF_CUSTOMERS_AFFECTED,
    cf.NO_CALLS AS NUM_OF_CALLS,
    ss.ACTION_TAKEN_1, 
    ss.ACTION_TAKEN_2, 
    ss.ACTION_TAKEN_3, 
    ss.ACTION_TAKEN_4, 
    ss.ACTION_TAKEN_5, 
    ss.ACTION_TAKEN_6, 
    ss.CREW_NOTES AS COMMENTS,     
    ef.DEVICENAME,     
    ef.DURATIONHM,
    -- convert to TIMESTAMP and bucket into 30-minute intervals
    TIMESTAMP_BUCKET(
      CAST(ef.STARTDATETIME AS TIMESTAMP),
      INTERVAL 30 MINUTE
    ) AS start_30min_bucket,
    ROW_NUMBER() OVER (
      PARTITION BY ef.EVENTNAME 
      ORDER BY ss.ACTION_TAKEN_1 DESC, cf.NO_CALLS DESC
    ) AS row_num
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss  
    ON ef.EVENTNAME = ss.EVENTNAME
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CALL_FACT` cf 
    ON cf.EVENTKEY = ef.EVENTKEY
  WHERE ef.STARTDATETIME BETWEEN "2026-01-24T22:00:00" 
    AND "2026-01-25T10:00:59"
    AND ef.RESTOREDDATETIME IS NOT NULL
    AND ef.EXCLUDETROUBLEFLAG = 0
    AND ef.MOMENTARYOUTAGEFLAG = 0
    AND ef.CANCELLEDFLAG = 0
    AND ef.PLANNEDOTGFLAG = 0
    AND ef.NONOUTGCALLFLAG = 0
    AND ef.ORPHANOUTAGEFLAG = 0
    AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP', 'INDIANA')
),

bucket_totals AS (
  SELECT
    start_30min_bucket,
    SUM(NUMBER_OF_CUSTOMERS_AFFECTED) AS PEAK_HALF_HOUR
  FROM ranked_events
  GROUP BY start_30min_bucket
)

SELECT
  re.* EXCEPT(row_num, start_30min_bucket),
  bt.PEAK_HALF_HOUR
FROM ranked_events re
JOIN bucket_totals bt
  ON re.start_30min_bucket = bt.start_30min_bucket
WHERE re.row_num = 1
ORDER BY bt.PEAK_HALF_HOUR DESC, re.STARTDATETIME;
