WITH ranked_events AS (
  SELECT
    ef.EVENTNAME,
    ef.STARTDATETIME,
    ef.RESTOREDDATETIME,
    ef.COMPLETEDDATETIME AS COMPLETION_DATE,
    ef.PLANNEDOTGFLAG,
    ef.SERVICECENTER,
    ef.FEEDERNAME,
    cd.CAUSECODE,
    cd.CAUSEDESC,
    ss.CREW_NAME,
    ss.CREW_ID,
    A.Tasks.WorkOrderTask.TaskAssignment.UserId AS CREW_NAME,
     omsat.action_taken AS ACTION_TAKEN,
    ef.OPERATORCOMMENTS AS COMMENTS,
    ROW_NUMBER() OVER (
      PARTITION BY ef.EVENTNAME 
      ORDER BY ef.COMPLETEDDATETIME DESC
    ) AS row_num
  FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss  
    ON ef.EVENTNAME = ss.EVENTNAME
  LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_CAUSE_DIM` cd 
    ON ef.causekey = cd.causekey
  LEFT JOIN `cnp-datafoundation-prod.EAI_ELEC_OPS.T_ELEC_ORDER_TASKS` A
    ON ef.EVENTNAME = A.OrderNumber AND  TIMESTAMP_TRUNC(A.OrderUpdateTS, DAY) BETWEEN TIMESTAMP("2024-09-01") AND TIMESTAMP("2025-08-31")
  LEFT JOIN (
          SELECT distinct
             eventname,
               string_agg(action_taken_name,' , ' ORDER BY eventname) AS action_taken
          FROM
             `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN`
         Where
         1=1
  GROUP BY
              eventname
     ) omsat ON ef.eventname = omsat.eventname
  WHERE ef.COMPLETEDDATETIME BETWEEN "2024-09-01T00:00:00" AND "2025-08-31T23:59:59"
  
    AND ( cd.CAUSECODE LIKE '%EM%' OR cd.CAUSECODE LIKE '%IN%' OR cd.CAUSECODE LIKE '%CR%' OR cd.CAUSECODE LIKE '%DC%' OR cd.CAUSECODE LIKE '%LA%' OR cd.CAUSECODE LIKE '%RS%' OR cd.CAUSECODE LIKE   '%TM%' OR cd.CAUSECODE LIKE '%UU%' OR cd.CAUSECODE LIKE '%VT%')
    AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP', 'INDIANA')
    ORDER BY ef.COMPLETEDDATETIME, ef.RESTOREDDATETIME, ef.STARTDATETIME
)
SELECT * EXCEPT(row_num)
FROM ranked_events
WHERE row_num = 1
;

