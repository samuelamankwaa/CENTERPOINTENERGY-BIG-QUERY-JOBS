SELECT 
       al.EVENTNAME,
       al.OPERATOR_ID AS CONTROLLER_ID,
       REGEXP_EXTRACT(al.NEW_VALUE, r'Status:([^;]+)') AS STATUS,
       ef.STARTDATETIME,
       ef.RESTOREDDATETIME,
       ef.TROUBLE_LVL,
       ss.OUTAGE_CAUSE_CODE,
       ss.OUTAGE_CAUSE_DESC,
       tk.ACTION_TAKEN_CAT_NO,
       tk.ACTION_TAKEN_NAME,      
       ss.CREW_NOTES AS COMMENTS,
       ef.DURATIONHM   
 FROM  `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` ef
 LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_GAP_AUDIT_LOG`  al ON al.EVENTNAME =  ef.EVENTNAME
 LEFT JOIN  `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE`  ss ON ss.EVENTNAME = ef.EVENTNAME
 LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN` tk ON tk.EVENTNAME = ef.EVENTNAME
  WHERE ef.STARTDATETIME >= DATETIME("2024-01-01T00:00:00") 
   AND ef.STARTDATETIME < DATETIME("2025-06-08T23:00:00")
   --AND al.OPERATOR_ID = '00226766'
   AND REGEXP_EXTRACT(al.NEW_VALUE, r'Status:([^;]+)') = 'Restored'
   --AND tk.ACTION_TAKEN_NAME = '710-PON case-no call(s)'
   AND tk.ACTION_TAKEN_CAT_NO = 710
  -- AND al.EVENTNAME = '55490'
  -- AND al.NEW_VALUE LIKE '%Operator_Id:00226766%'
   AND ss.CREW_NOTES IS NOT NULL  
   AND ef.EXCLUDETROUBLEFLAG = 0
   AND ef.MOMENTARYOUTAGEFLAG = 0
   AND ef.CANCELLEDFLAG = 0
   AND ef.PLANNEDOTGFLAG = 0
   AND ef.NONOUTGCALLFLAG = 0
   AND ef.ORPHANOUTAGEFLAG = 0
   AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP','INDIANA')
   ORDER BY ef.STARTDATETIME


--al.OPERATOR_ID = '00226766'
--AND 
--al.NEW_VALUE LIKE '%Restored%'
--AND
--A.Tasks.WorkOrderTask.TaskTracking.EventByUserId = '00226766'
--
--710 -  PON case - no call(s)

--SELECT * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` 
---order by ACTION_TAKEN_1,ACTION_TAKEN_2,ACTION_TAKEN_3,ACTION_TAKEN_4,ACTION_TAKEN_5,ACTION_TAKEN_6


--SELECT * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_GAP_AUDIT_LOG` 
--WHERE EVENTNAME = '5549080'


 --al ON al.EVENTNAME = B.EVENTNAME
--LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ss ON ss.EVENTNAME = A.OrderNumber
--LEFT JOIN `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` 

--ef ON ef.EVENTNAME = A.OrderNumber
--SELECT DISTINCT OUTAGE_CAUSE_CODE FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_SERVICE_SUITE` ORDER BY OUTAGE_CAUSE_CODE 
--SELECT * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_EVENT_FACT` LIMIT 100
--SELECT DISTINCT * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_ALL_ACTIONS_TAKEN` 
--SELECT * FROM `cnp-datafoundation-prod.TECHOPS_FOCALPOINT_VIEWS.V_OMS_GAP_AUDIT_LOG` 
--WHERE OPERATOR_ID = '00226766'
--AND OUTAGE_DATE BETWEEN DATETIME("2025-01-01") AND DATETIME("2025-06-05")
--AND NEW_VALUE LIKE '%Restored%'
--ORDER BY ACTION_TAKEN_2
